<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Suivi Nutritionnel Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #4a5568;
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            color: #718096;
            font-size: 1.1rem;
        }

        .sync-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        .sync-status.synced {
            background: #c6f6d5;
            color: #2f855a;
        }

        .sync-status.syncing {
            background: #feebc8;
            color: #c05621;
        }

        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 30px;
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            font-weight: 500;
            white-space: nowrap;
        }

        .tab.active {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            background: white;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 16px rgba(66, 153, 225, 0.3);
        }

        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .stat-card p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .macro-bar {
            background: #e2e8f0;
            border-radius: 10px;
            height: 20px;
            margin: 10px 0;
            overflow: hidden;
            position: relative;
        }

        .macro-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
            position: relative;
        }

        .macro-fill.protein { background: linear-gradient(90deg, #48bb78, #38a169); }
        .macro-fill.carbs { background: linear-gradient(90deg, #ed8936, #dd6b20); }
        .macro-fill.fat { background: linear-gradient(90deg, #9f7aea, #805ad5); }

        .food-search {
            margin-bottom: 20px;
        }

        .search-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .search-controls input {
            flex: 1;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
        }

        .scanner-container {
            display: none;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
            position: relative;
        }

        .scanner-container video {
            width: 100%;
            height: 300px;
            object-fit: cover;
        }

        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 100px;
            border: 2px solid #48bb78;
            border-radius: 10px;
        }

        .food-results {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            background: white;
        }

        .food-item {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .food-item:hover {
            background-color: #f7fafc;
        }

        .food-item:last-child {
            border-bottom: none;
        }

        .food-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .food-brand {
            color: #718096;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .food-nutrition {
            font-size: 0.8rem;
            color: #4a5568;
        }

        .portion-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .portion-btn {
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .portion-btn.selected {
            border-color: #667eea;
            background: #f0f4ff;
            color: #667eea;
        }

        .portion-btn:hover {
            border-color: #cbd5e0;
        }

        .meal-log {
            background: #f7fafc;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .meal-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .meal-entry:last-child {
            border-bottom: none;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #718096;
        }

        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }

        .success {
            background: #c6f6d5;
            color: #2f855a;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }

        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        .ai-chat {
            background: #f7fafc;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 10px;
            max-width: 80%;
        }

        .chat-message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
        }

        .chat-message.ai {
            background: white;
            border: 1px solid #e2e8f0;
            margin-right: auto;
        }

        .chat-input {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .chat-input input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
        }

        .export-section {
            background: #f7fafc;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                margin-bottom: 5px;
            }

            .search-controls {
                flex-direction: column;
            }

            .export-buttons {
                flex-direction: column;
            }
        }

        .hidden {
            display: none;
        }

        .backup-section {
            background: linear-gradient(135deg, #4fd1c7 0%, #38b2ac 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .backup-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .backup-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .backup-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .data-size {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 10px;
        }

        .quantity-input {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .quantity-input input {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🥗 Mon Suivi Nutritionnel Pro</h1>
            <p>Scanner • IA Nutritionnelle • Graphiques • Sauvegarde Robuste</p>
            <div id="syncStatus" class="sync-status synced">✅ Données synchronisées</div>
        </div>

        <div class="tabs">
            <div class="tab active" data-section="dashboard">📊 Aujourd'hui</div>
            <div class="tab" data-section="profile">👤 Profil</div>
            <div class="tab" data-section="search">🔍 Recherche</div>
            <div class="tab" data-section="analytics">📈 Analyses</div>
            <div class="tab" data-section="ai">🤖 IA Nutrition</div>
            <div class="tab" data-section="data">💾 Données</div>
        </div>

        <div class="content">
            <!-- Section Dashboard -->
            <div id="dashboard" class="section active">
                <h2>Tableau de bord - <span id="currentDate"></span></h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 id="caloriesConsumed">0</h3>
                        <p>Calories consommées</p>
                        <small>Objectif: <span id="caloriesTarget">2000</span></small>
                    </div>
                    <div class="stat-card">
                        <h3 id="proteinConsumed">0g</h3>
                        <p>Protéines</p>
                        <small>Objectif: <span id="proteinTarget">150g</span></small>
                    </div>
                    <div class="stat-card">
                        <h3 id="carbsConsumed">0g</h3>
                        <p>Glucides</p>
                        <small>Objectif: <span id="carbsTarget">250g</span></small>
                    </div>
                    <div class="stat-card">
                        <h3 id="fatConsumed">0g</h3>
                        <p>Lipides</p>
                        <small>Objectif: <span id="fatTarget">67g</span></small>
                    </div>
                </div>

                <div class="macro-bars">
                    <h3>Progression des macronutriments</h3>
                    <div>
                        <label>Protéines (<span id="proteinPercent">0</span>%)</label>
                        <div class="macro-bar">
                            <div class="macro-fill protein" id="proteinBar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div>
                        <label>Glucides (<span id="carbsPercent">0</span>%)</label>
                        <div class="macro-bar">
                            <div class="macro-fill carbs" id="carbsBar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div>
                        <label>Lipides (<span id="fatPercent">0</span>%)</label>
                        <div class="macro-bar">
                            <div class="macro-fill fat" id="fatBar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>Évolution quotidienne (7 derniers jours)</h3>
                    <div class="chart-wrapper">
                        <canvas id="weeklyChart"></canvas>
                    </div>
                </div>

                <div class="meal-log">
                    <h3>Repas d'aujourd'hui</h3>
                    <div id="todayMeals">
                        <p style="text-align: center; color: #718096; padding: 20px;">Aucun repas ajouté aujourd'hui</p>
                    </div>
                </div>
            </div>

            <!-- Section Profil -->
            <div id="profile" class="section">
                <h2>Profil et Objectifs</h2>
                
                <div class="form-group">
                    <label for="gender">Sexe</label>
                    <select id="gender">
                        <option value="male">Homme</option>
                        <option value="female">Femme</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="age">Âge (années)</label>
                    <input type="number" id="age" placeholder="Ex: 30" min="15" max="100">
                </div>

                <div class="form-group">
                    <label for="height">Taille (cm)</label>
                    <input type="number" id="height" placeholder="Ex: 175" min="100" max="250">
                </div>

                <div class="form-group">
                    <label for="weight">Poids actuel (kg)</label>
                    <input type="number" id="weight" placeholder="Ex: 70" min="30" max="200" step="0.1">
                </div>

                <div class="form-group">
                    <label for="goal">Objectif</label>
                    <select id="goal">
                        <option value="lose">Perdre du poids (-0.5kg/semaine)</option>
                        <option value="maintain">Maintenir le poids</option>
                        <option value="gain">Prendre du muscle (+0.3kg/semaine)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="activity">Niveau d'activité physique</label>
                    <select id="activity">
                        <option value="1.2">Sédentaire (pas d'exercice)</option>
                        <option value="1.375">Légèrement actif (1-3x/semaine)</option>
                        <option value="1.55">Modérément actif (3-5x/semaine)</option>
                        <option value="1.725">Très actif (6-7x/semaine)</option>
                        <option value="1.9">Extrêmement actif (2x/jour)</option>
                    </select>
                </div>

                <button class="btn" id="calculateBtn">Calculer mes besoins</button>
                <button class="btn btn-secondary" id="saveProfileBtn">Sauvegarder le profil</button>

                <div id="calculationResults" class="hidden" style="margin-top: 30px; padding: 20px; background: #f7fafc; border-radius: 10px;">
                    <h3>Résultats du calcul</h3>
                    <p><strong>BMR (Métabolisme de base):</strong> <span id="bmrResult"></span> kcal/jour</p>
                    <p><strong>TDEE (Dépense énergétique totale):</strong> <span id="tdeeResult"></span> kcal/jour</p>
                    <p><strong>Calories recommandées:</strong> <span id="caloriesResult"></span> kcal/jour</p>
                    <p><strong>Protéines:</strong> <span id="proteinResult"></span> g/jour</p>
                    <p><strong>Glucides:</strong> <span id="carbsResult"></span> g/jour</p>
                    <p><strong>Lipides:</strong> <span id="fatResult"></span> g/jour</p>
                </div>
            </div>

            <!-- Section Recherche -->
            <div id="search" class="section">
                <h2>🔍 Recherche d'aliments</h2>
                <p style="margin-bottom: 20px; color: #718096;">
                    <strong>Base de données Open Food Facts France</strong> • 
                    Plus de 2 millions de produits français • 
                    <a href="https://fr.openfoodfacts.org" target="_blank" style="color: #667eea;">En savoir plus</a>
                </p>
                
                <div class="search-controls">
                    <input type="text" id="foodSearchInput" placeholder="Rechercher un aliment français (ex: yaourt danone, pain complet, pomme)...">
                    <button class="btn btn-warning" id="scannerBtn">📷 Scanner</button>
                </div>

                <div style="margin-bottom: 15px; padding: 10px; background: #f0f9ff; border-radius: 8px; font-size: 0.9rem;">
                    <strong>💡 Exemples de recherche :</strong>
                    <div style="margin-top: 5px;">
                        <span class="btn" style="padding: 3px 8px; margin: 2px; font-size: 0.8rem; cursor: pointer;" onclick="document.getElementById('foodSearchInput').value='yaourt nature'; searchFood();">yaourt nature</span>
                        <span class="btn" style="padding: 3px 8px; margin: 2px; font-size: 0.8rem; cursor: pointer;" onclick="document.getElementById('foodSearchInput').value='pain complet'; searchFood();">pain complet</span>
                        <span class="btn" style="padding: 3px 8px; margin: 2px; font-size: 0.8rem; cursor: pointer;" onclick="document.getElementById('foodSearchInput').value='pomme'; searchFood();">pomme</span>
                        <span class="btn" style="padding: 3px 8px; margin: 2px; font-size: 0.8rem; cursor: pointer;" onclick="document.getElementById('foodSearchInput').value='riz basmati'; searchFood();">riz basmati</span>
                    </div>
                </div>

                <div style="margin-bottom: 20px; padding: 10px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
                    <strong>⚠️ Important pour les tests :</strong>
                    <p style="margin: 5px 0; font-size: 0.9rem;">
                        L'application doit être hébergée sur <strong>HTTPS</strong> (pas en local file://) pour accéder à l'API Open Food Facts. 
                        Déployez sur GitHub Pages, Netlify ou Vercel pour tester la recherche d'aliments.
                    </p>
                </div>

                <div id="scannerContainer" class="scanner-container">
                    <video id="scannerVideo"></video>
                    <div class="scanner-overlay"></div>
                    <div style="text-align: center; padding: 15px; background: rgba(0,0,0,0.8); color: white;">
                        <p>📱 Pointez l'appareil photo vers le code-barres</p>
                        <button class="btn btn-danger" id="stopScannerBtn">Arrêter le scan</button>
                    </div>
                </div>

                <div id="searchResults" class="food-results hidden"></div>

                <div id="addFoodForm" class="hidden" style="background: #f7fafc; padding: 20px; border-radius: 10px;">
                    <h3>✅ Ajouter à mon journal</h3>
                    <div id="selectedFoodInfo"></div>
                    
                    <h4>🍽️ Choisir la portion :</h4>
                    <div id="portionSelector" class="portion-selector"></div>
                    
                    <div class="quantity-input">
                        <input type="number" id="customQuantity" placeholder="Quantité" min="1" step="0.1">
                        <select id="customUnit">
                            <option value="g">grammes</option>
                            <option value="ml">millilitres</option>
                            <option value="portion">portion(s)</option>
                        </select>
                        <button class="btn btn-secondary" id="addToJournalBtn">➕ Ajouter</button>
                        <button class="btn btn-danger" id="cancelAddBtn">❌ Annuler</button>
                    </div>
                </div>
            </div>

            <!-- Section Analytics -->
            <div id="analytics" class="section">
                <h2>Analyses et Statistiques</h2>
                
                <div class="chart-container">
                    <h3>Évolution des calories (30 derniers jours)</h3>
                    <div class="chart-wrapper">
                        <canvas id="caloriesChart"></canvas>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 id="avgCalories">0</h3>
                        <p>Calories moyennes/jour</p>
                        <small>(7 derniers jours)</small>
                    </div>
                    <div class="stat-card">
                        <h3 id="bestDay">-</h3>
                        <p>Meilleur jour</p>
                        <small>(objectifs atteints)</small>
                    </div>
                    <div class="stat-card">
                        <h3 id="streak">0</h3>
                        <p>Jours consécutifs</p>
                        <small>(suivi régulier)</small>
                    </div>
                    <div class="stat-card">
                        <h3 id="totalFoods">0</h3>
                        <p>Aliments différents</p>
                        <small>(enregistrés)</small>
                    </div>
                </div>
            </div>

            <!-- Section IA Nutrition -->
            <div id="ai" class="section">
                <h2>Assistant IA Nutritionnel</h2>
                <p style="margin-bottom: 20px; color: #718096;">Obtenez des conseils personnalisés et des suggestions de recettes</p>
                
                <div class="ai-chat" id="aiChat">
                    <div class="chat-message ai">
                        <strong>🤖 Assistant IA</strong><br>
                        Bonjour ! Je suis votre assistant nutritionnel personnel. Je peux vous aider avec :
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li>📊 Analyser votre progression nutritionnelle</li>
                            <li>🍽️ Suggérer des recettes adaptées à vos macros</li>
                            <li>💡 Donner des conseils personnalisés</li>
                            <li>🎯 Optimiser vos objectifs</li>
                        </ul>
                        Que puis-je faire pour vous aujourd'hui ?
                    </div>
                </div>

                <div class="chat-input">
                    <input type="text" id="aiInput" placeholder="Posez votre question nutritionnelle...">
                    <button class="btn" id="sendAiBtn">Envoyer</button>
                </div>

                <div style="margin-top: 20px;">
                    <h4>Suggestions rapides :</h4>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
                        <button class="btn btn-secondary" data-ai-question="Analyse ma progression cette semaine">📊 Analyser ma semaine</button>
                        <button class="btn btn-secondary" data-ai-question="Suggère-moi des recettes riches en protéines">🥩 Recettes protéinées</button>
                        <button class="btn btn-secondary" data-ai-question="Comment améliorer mon équilibre nutritionnel ?">⚖️ Conseils équilibre</button>
                        <button class="btn btn-secondary" data-ai-question="Calcule mes besoins pour demain">🎯 Besoins demain</button>
                    </div>
                </div>
            </div>

            <!-- Section Données -->
            <div id="data" class="section">
                <h2>Gestion des Données</h2>
                
                <div class="backup-section">
                    <h3>💾 Sauvegarde & Synchronisation</h3>
                    <p>Vos données sont automatiquement sauvegardées sur cet appareil et synchronisées entre navigateurs.</p>
                    <div class="data-size">
                        Taille des données : <span id="dataSize">Calcul en cours...</span>
                    </div>
                    <div class="backup-buttons">
                        <button class="backup-btn" id="exportBtn">📤 Exporter les données</button>
                        <button class="backup-btn" id="importBtn">📥 Importer les données</button>
                        <button class="backup-btn" id="syncBtn">☁️ Sync Cloud</button>
                        <button class="backup-btn" id="resetBtn">🗑️ Réinitialiser</button>
                    </div>
                </div>

                <div class="export-section">
                    <h3>📊 Export & Rapports</h3>
                    <p>Générez des rapports détaillés de votre progression</p>
                    <div class="export-buttons">
                        <button class="btn" id="weeklyReportBtn">📋 Rapport hebdomadaire</button>
                        <button class="btn" id="monthlyReportBtn">📅 Rapport mensuel</button>
                        <button class="btn" id="csvExportBtn">📊 Export CSV</button>
                        <button class="btn" id="pdfBtn">📄 Générer PDF</button>
                    </div>
                </div>

                <div class="meal-log">
                    <h3>📱 Synchronisation Multi-Appareils</h3>
                    <p>Vos données sont synchronisées automatiquement entre :</p>
                    <ul style="margin: 15px 0; padding-left: 20px;">
                        <li>✅ Navigateur desktop (Chrome, Firefox, Safari)</li>
                        <li>✅ Navigateur mobile (smartphones/tablettes)</li>
                        <li>✅ Mode hors-ligne (Progressive Web App)</li>
                        <li>✅ Stockage local sécurisé (IndexedDB + localStorage)</li>
                    </ul>
                    <p style="font-size: 0.9rem; color: #718096;">
                        Dernière synchronisation : <span id="lastSync">Jamais</span>
                    </p>
                </div>

                <input type="file" id="importFile" accept=".json" style="display: none;">
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let userData = {
            profile: {},
            dailyNeeds: {},
            foodJournal: {},
            settings: {
                units: 'metric',
                language: 'fr',
                notifications: true
            },
            sync: {
                lastBackup: null,
                cloudEnabled: false,
                autoSync: true
            }
        };

        let selectedFood = null;
        let selectedPortion = null;
        let searchTimeout = null;
        let scannerActive = false;
        let charts = {};

        // Portions communes prédéfinies
        const commonPortions = {
            default: [
                { name: '100g', value: 100, unit: 'g' },
                { name: '50g', value: 50, unit: 'g' },
                { name: '200g', value: 200, unit: 'g' },
                { name: '1 portion', value: 1, unit: 'portion' }
            ],
            liquid: [
                { name: '250ml (verre)', value: 250, unit: 'ml' },
                { name: '500ml (bouteille)', value: 500, unit: 'ml' },
                { name: '100ml', value: 100, unit: 'ml' },
                { name: '1L', value: 1000, unit: 'ml' }
            ],
            snack: [
                { name: '30g (portion)', value: 30, unit: 'g' },
                { name: '1 unité', value: 1, unit: 'portion' },
                { name: '2 unités', value: 2, unit: 'portion' },
                { name: '50g', value: 50, unit: 'g' }
            ]
        };

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            try {
                showSyncStatus('syncing');
                await loadUserData();
                updateCurrentDate();
                updateDashboard();
                initializeEventListeners();
                initializeCharts();
                calculateDataSize();
                updateSyncInfo();
                
                // Auto-sauvegarde toutes les 30 secondes
                setInterval(autoSave, 30000);
                
                showSyncStatus('synced');
            } catch (error) {
                console.error('Erreur initialisation:', error);
                showSyncStatus('error');
            }
        }

        function initializeEventListeners() {
            // Navigation
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    showSection(section);
                });
            });

            // Profil
            const calculateBtn = document.getElementById('calculateBtn');
            if (calculateBtn) {
                calculateBtn.addEventListener('click', calculateNeeds);
            }

            const saveProfileBtn = document.getElementById('saveProfileBtn');
            if (saveProfileBtn) {
                saveProfileBtn.addEventListener('click', saveProfile);
            }

            // Recherche
            const foodSearchInput = document.getElementById('foodSearchInput');
            if (foodSearchInput) {
                foodSearchInput.addEventListener('input', searchFood);
            }

            const scannerBtn = document.getElementById('scannerBtn');
            if (scannerBtn) {
                scannerBtn.addEventListener('click', toggleScanner);
            }

            const stopScannerBtn = document.getElementById('stopScannerBtn');
            if (stopScannerBtn) {
                stopScannerBtn.addEventListener('click', stopScanner);
            }

            const addToJournalBtn = document.getElementById('addToJournalBtn');
            if (addToJournalBtn) {
                addToJournalBtn.addEventListener('click', addToJournal);
            }

            const cancelAddBtn = document.getElementById('cancelAddBtn');
            if (cancelAddBtn) {
                cancelAddBtn.addEventListener('click', cancelAddFood);
            }

            // IA
            const sendAiBtn = document.getElementById('sendAiBtn');
            if (sendAiBtn) {
                sendAiBtn.addEventListener('click', sendAiMessage);
            }

            const aiInput = document.getElementById('aiInput');
            if (aiInput) {
                aiInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        sendAiMessage();
                    }
                });
            }

            // Questions rapides IA
            document.querySelectorAll('[data-ai-question]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const question = this.getAttribute('data-ai-question');
                    askAi(question);
                });
            });

            // Données
            const exportBtn = document.getElementById('exportBtn');
            if (exportBtn) {
                exportBtn.addEventListener('click', exportData);
            }

            const importBtn = document.getElementById('importBtn');
            if (importBtn) {
                importBtn.addEventListener('click', importData);
            }

            const syncBtn = document.getElementById('syncBtn');
            if (syncBtn) {
                syncBtn.addEventListener('click', syncToCloud);
            }

            const resetBtn = document.getElementById('resetBtn');
            if (resetBtn) {
                resetBtn.addEventListener('click', resetData);
            }

            const weeklyReportBtn = document.getElementById('weeklyReportBtn');
            if (weeklyReportBtn) {
                weeklyReportBtn.addEventListener('click', generateWeeklyReport);
            }

            const monthlyReportBtn = document.getElementById('monthlyReportBtn');
            if (monthlyReportBtn) {
                monthlyReportBtn.addEventListener('click', generateMonthlyReport);
            }

            const csvExportBtn = document.getElementById('csvExportBtn');
            if (csvExportBtn) {
                csvExportBtn.addEventListener('click', exportToCSV);
            }

            const pdfBtn = document.getElementById('pdfBtn');
            if (pdfBtn) {
                pdfBtn.addEventListener('click', generatePDF);
            }

            const importFile = document.getElementById('importFile');
            if (importFile) {
                importFile.addEventListener('change', handleImportFile);
            }
        }

        function showSection(sectionName) {
            try {
                // Masquer toutes les sections
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.remove('active');
                });
                
                // Masquer tous les onglets actifs
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // Afficher la section sélectionnée
                const targetSection = document.getElementById(sectionName);
                if (targetSection) {
                    targetSection.classList.add('active');
                }
                
                // Activer l'onglet correspondant
                document.querySelectorAll('.tab').forEach(tab => {
                    if (tab.getAttribute('data-section') === sectionName) {
                        tab.classList.add('active');
                    }
                });
                
                // Initialiser les graphiques si nécessaire
                if (sectionName === 'analytics') {
                    setTimeout(updateAnalyticsCharts, 100);
                }
            } catch (error) {
                console.error('Erreur showSection:', error);
            }
        }

        function calculateNeeds() {
            try {
                const gender = document.getElementById('gender').value;
                const age = parseInt(document.getElementById('age').value);
                const height = parseInt(document.getElementById('height').value);
                const weight = parseFloat(document.getElementById('weight').value);
                const activity = parseFloat(document.getElementById('activity').value);
                const goal = document.getElementById('goal').value;

                if (!age || !height || !weight) {
                    alert('Veuillez remplir tous les champs du profil');
                    return;
                }

                // Calcul BMR
                let bmr;
                if (gender === 'male') {
                    bmr = 88.362 + (13.397 * weight) + (4.799 * height) - (5.677 * age);
                } else {
                    bmr = 447.593 + (9.247 * weight) + (3.098 * height) - (4.330 * age);
                }

                // Calcul TDEE
                const tdee = bmr * activity;

                // Ajustement selon l'objectif
                let calories;
                switch(goal) {
                    case 'lose':
                        calories = tdee - 500;
                        break;
                    case 'gain':
                        calories = tdee + 300;
                        break;
                    default:
                        calories = tdee;
                }

                // Calcul des macronutriments
                const protein = weight * 2.2;
                const fat = calories * 0.25 / 9;
                const carbs = (calories - (protein * 4) - (fat * 9)) / 4;

                userData.dailyNeeds = {
                    bmr: Math.round(bmr),
                    tdee: Math.round(tdee),
                    calories: Math.round(calories),
                    protein: Math.round(protein),
                    carbs: Math.round(carbs),
                    fat: Math.round(fat)
                };

                // Affichage des résultats
                updateElement('bmrResult', userData.dailyNeeds.bmr);
                updateElement('tdeeResult', userData.dailyNeeds.tdee);
                updateElement('caloriesResult', userData.dailyNeeds.calories);
                updateElement('proteinResult', userData.dailyNeeds.protein);
                updateElement('carbsResult', userData.dailyNeeds.carbs);
                updateElement('fatResult', userData.dailyNeeds.fat);

                const resultsElement = document.getElementById('calculationResults');
                if (resultsElement) {
                    resultsElement.classList.remove('hidden');
                }
                
                updateDashboard();
                saveUserData();
            } catch (error) {
                console.error('Erreur calcul besoins:', error);
                alert('Erreur lors du calcul. Veuillez vérifier vos données.');
            }
        }

        function saveProfile() {
            try {
                userData.profile = {
                    gender: document.getElementById('gender').value,
                    age: document.getElementById('age').value,
                    height: document.getElementById('height').value,
                    weight: document.getElementById('weight').value,
                    goal: document.getElementById('goal').value,
                    activity: document.getElementById('activity').value
                };
                
                saveUserData();
                showSuccessMessage('Profil sauvegardé avec succès !');
            } catch (error) {
                console.error('Erreur sauvegarde profil:', error);
                alert('Erreur lors de la sauvegarde du profil');
            }
        }

        async function searchFood() {
            try {
                const query = document.getElementById('foodSearchInput').value.trim();
                const resultsDiv = document.getElementById('searchResults');
                
                if (!query || query.length < 3) {
                    if (resultsDiv) resultsDiv.classList.add('hidden');
                    return;
                }

                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(async () => {
                    try {
                        if (resultsDiv) {
                            resultsDiv.innerHTML = '<div class="loading">🔍 Recherche en cours dans la base française...</div>';
                            resultsDiv.classList.remove('hidden');
                        }

                        // URL avec plus de champs pour de meilleurs résultats
                        const searchUrl = `https://fr.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(query)}&search_simple=1&action=process&json=1&page_size=15&fields=product_name,brands,nutriments,serving_size,image_url,categories,labels,countries_tags`;
                        
                        console.log('Recherche:', query);
                        console.log('URL:', searchUrl);
                        
                        const response = await fetch(searchUrl, {
                            method: 'GET',
                            headers: {
                                'User-Agent': 'NutritionTracker/1.0 (contact@nutrition-tracker.com)'
                            }
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }

                        const data = await response.json();
                        console.log('Réponse API:', data);

                        if (data.products && data.products.length > 0) {
                            // Filtrer les produits français et avec des données nutritionnelles
                            const validProducts = data.products.filter(product => {
                                const hasNutriments = product.nutriments && 
                                    (product.nutriments['energy-kcal_100g'] || product.nutriments['energy_100g']);
                                const isFrench = !product.countries_tags || 
                                    product.countries_tags.includes('en:france') || 
                                    product.countries_tags.length === 0;
                                return hasNutriments && isFrench && product.product_name;
                            });

                            if (validProducts.length > 0) {
                                displayFoodResults(validProducts);
                                showSuccessMessage(`${validProducts.length} produits trouvés !`);
                            } else {
                                if (resultsDiv) {
                                    resultsDiv.innerHTML = `
                                        <div class="error">
                                            <p>Aucun produit français avec données nutritionnelles trouvé.</p>
                                            <p><strong>Suggestions :</strong></p>
                                            <ul>
                                                <li>• Essayez "${query.split(' ')[0]}" (un seul mot)</li>
                                                <li>• Recherchez la marque + produit (ex: "danone yaourt")</li>
                                                <li>• Utilisez le scanner pour les codes-barres</li>
                                            </ul>
                                        </div>
                                    `;
                                }
                            }
                        } else {
                            if (resultsDiv) {
                                resultsDiv.innerHTML = `
                                    <div class="error">
                                        <p>Aucun résultat pour "${query}"</p>
                                        <p><strong>Suggestions :</strong></p>
                                        <ul>
                                            <li>• Vérifiez l'orthographe</li>
                                            <li>• Essayez des termes plus généraux</li>
                                            <li>• Exemple : "pain", "fromage", "pomme"</li>
                                        </ul>
                                    </div>
                                `;
                            }
                        }
                    } catch (error) {
                        console.error('Erreur API Open Food Facts:', error);
                        if (resultsDiv) {
                            resultsDiv.innerHTML = `
                                <div class="error">
                                    <p><strong>Erreur de connexion à la base alimentaire</strong></p>
                                    <p>Détails: ${error.message}</p>
                                    <p><strong>Solutions :</strong></p>
                                    <ul>
                                        <li>• Vérifiez votre connexion internet</li>
                                        <li>• L'application doit être sur HTTPS (pas file://)</li>
                                        <li>• Réessayez dans quelques secondes</li>
                                    </ul>
                                    <button class="btn btn-secondary" onclick="searchFood()" style="margin-top: 10px;">🔄 Réessayer</button>
                                </div>
                            `;
                        }
                    }
                }, 800); // Délai plus long pour éviter trop de requêtes
            } catch (error) {
                console.error('Erreur recherche globale:', error);
            }
        }

        function displayFoodResults(products) {
            const resultsDiv = document.getElementById('searchResults');
            if (!resultsDiv) return;
            
            resultsDiv.innerHTML = '';

            products.forEach((product, index) => {
                const nutrients = product.nutriments || {};
                
                // Calcul plus robuste des valeurs nutritionnelles
                let calories = nutrients['energy-kcal_100g'] || 0;
                if (!calories && nutrients['energy_100g']) {
                    calories = Math.round(nutrients['energy_100g'] / 4.184); // Conversion kJ vers kcal
                }
                
                const protein = Math.round((nutrients.proteins_100g || 0) * 10) / 10;
                const carbs = Math.round((nutrients.carbohydrates_100g || 0) * 10) / 10;
                const fat = Math.round((nutrients.fat_100g || 0) * 10) / 10;
                const fiber = Math.round((nutrients.fiber_100g || 0) * 10) / 10;
                
                // Score de qualité nutritionnelle
                const nutritionScore = nutrients['nutrition-score-fr'] || nutrients['nutriscore_score'];
                const nutritionGrade = nutrients['nutrition-score-fr_grade'] || nutrients['nutriscore_grade'] || '';
                
                const foodItem = document.createElement('div');
                foodItem.className = 'food-item';
                foodItem.addEventListener('click', () => selectFood(product));
                
                // Couleur du Nutri-Score
                const gradeColors = {
                    'a': '#00A651', 'b': '#85BB2F', 'c': '#FFCC00', 'd': '#F39C00', 'e': '#E4002B'
                };
                const gradeColor = gradeColors[nutritionGrade.toLowerCase()] || '#ccc';
                
                foodItem.innerHTML = `
                    <div class="food-name">${product.product_name || 'Produit sans nom'}</div>
                    <div class="food-brand">${product.brands || 'Marque inconnue'}</div>
                    <div class="food-nutrition">
                        📊 ${Math.round(calories)} kcal • 🥩 ${protein}g prot. • 🍞 ${carbs}g gluc. • 🥑 ${fat}g lip.
                        ${fiber > 0 ? ` • 🌾 ${fiber}g fibres` : ''}
                        ${nutritionGrade ? ` • <span style="background: ${gradeColor}; color: white; padding: 2px 6px; border-radius: 3px; font-weight: bold;">Nutri-Score ${nutritionGrade.toUpperCase()}</span>` : ''}
                    </div>
                    <div style="font-size: 0.7rem; color: #9ca3af; margin-top: 5px;">
                        Pour 100g • Cliquez pour ajouter • Produit ${index + 1}
                    </div>
                `;
                
                resultsDiv.appendChild(foodItem);
            });

            // Ajouter un message d'aide en bas
            const helpDiv = document.createElement('div');
            helpDiv.className = 'loading';
            helpDiv.style.borderTop = '1px solid #e2e8f0';
            helpDiv.style.fontSize = '0.8rem';
            helpDiv.innerHTML = `
                💡 <strong>Astuce :</strong> Cliquez sur un aliment pour personnaliser la portion. 
                Les valeurs sont données pour 100g par défaut.
            `;
            resultsDiv.appendChild(helpDiv);
        }

        function selectFood(product) {
            try {
                selectedFood = product;
                selectedPortion = null;
                const nutrients = product.nutriments || {};
                
                const infoDiv = document.getElementById('selectedFoodInfo');
                if (infoDiv) {
                    infoDiv.innerHTML = `
                        <h4>${product.product_name}</h4>
                        <p><strong>Marque:</strong> ${product.brands || 'Non spécifiée'}</p>
                        <p><strong>Valeurs nutritionnelles pour 100g:</strong></p>
                        <ul>
                            <li>Calories: ${Math.round(nutrients['energy-kcal_100g'] || 0)} kcal</li>
                            <li>Protéines: ${Math.round((nutrients.proteins_100g || 0) * 10) / 10}g</li>
                            <li>Glucides: ${Math.round((nutrients.carbohydrates_100g || 0) * 10) / 10}g</li>
                            <li>Lipides: ${Math.round((nutrients.fat_100g || 0) * 10) / 10}g</li>
                        </ul>
                    `;
                }
                
                generatePortionOptions(product);
                
                const searchResults = document.getElementById('searchResults');
                const addFoodForm = document.getElementById('addFoodForm');
                const customQuantity = document.getElementById('customQuantity');
                
                if (searchResults) searchResults.classList.add('hidden');
                if (addFoodForm) addFoodForm.classList.remove('hidden');
                if (customQuantity) customQuantity.value = '100';
            } catch (error) {
                console.error('Erreur sélection aliment:', error);
            }
        }

        function generatePortionOptions(product) {
            try {
                const container = document.getElementById('portionSelector');
                if (!container) return;
                
                const categories = product.categories || '';
                const productName = (product.product_name || '').toLowerCase();
                
                // Portions intelligentes selon le type d'aliment
                let portions = [...commonPortions.default];
                
                // Boissons
                if (categories.includes('beverage') || categories.includes('boisson') || 
                    productName.includes('eau') || productName.includes('jus') || productName.includes('soda')) {
                    portions = [
                        { name: '250ml (1 verre)', value: 250, unit: 'ml' },
                        { name: '330ml (canette)', value: 330, unit: 'ml' },
                        { name: '500ml (bouteille)', value: 500, unit: 'ml' },
                        { name: '1L (grande bouteille)', value: 1000, unit: 'ml' },
                        { name: '100ml', value: 100, unit: 'ml' }
                    ];
                }
                // Fruits et légumes
                else if (categories.includes('fruit') || categories.includes('vegetable') || categories.includes('légume') ||
                         productName.includes('pomme') || productName.includes('banane') || productName.includes('orange')) {
                    portions = [
                        { name: '1 moyenne (150g)', value: 150, unit: 'g' },
                        { name: '1 petite (100g)', value: 100, unit: 'g' },
                        { name: '1 grosse (200g)', value: 200, unit: 'g' },
                        { name: '1 portion (80g)', value: 80, unit: 'g' },
                        { name: '100g', value: 100, unit: 'g' }
                    ];
                }
                // Yaourts et desserts
                else if (categories.includes('yaourt') || categories.includes('yogurt') || categories.includes('dessert') ||
                         productName.includes('yaourt') || productName.includes('yogurt')) {
                    portions = [
                        { name: '1 pot (125g)', value: 125, unit: 'g' },
                        { name: '1 petit pot (100g)', value: 100, unit: 'g' },
                        { name: '1 grand pot (150g)', value: 150, unit: 'g' },
                        { name: '2 pots (250g)', value: 250, unit: 'g' }
                    ];
                }
                // Pain et céréales
                else if (categories.includes('bread') || categories.includes('cereal') || categories.includes('pain') ||
                         productName.includes('pain') || productName.includes('céréale')) {
                    portions = [
                        { name: '1 tranche (25g)', value: 25, unit: 'g' },
                        { name: '2 tranches (50g)', value: 50, unit: 'g' },
                        { name: '1 bol (30g)', value: 30, unit: 'g' },
                        { name: '100g', value: 100, unit: 'g' }
                    ];
                }
                // Fromages
                else if (categories.includes('cheese') || categories.includes('fromage') ||
                         productName.includes('fromage') || productName.includes('cheese')) {
                    portions = [
                        { name: '1 portion (30g)', value: 30, unit: 'g' },
                        { name: '1 tranche (20g)', value: 20, unit: 'g' },
                        { name: '2 portions (60g)', value: 60, unit: 'g' },
                        { name: '100g', value: 100, unit: 'g' }
                    ];
                }
                // Viandes et poissons
                else if (categories.includes('meat') || categories.includes('fish') || categories.includes('viande') ||
                         productName.includes('poulet') || productName.includes('bœuf') || productName.includes('porc') ||
                         productName.includes('saumon') || productName.includes('thon')) {
                    portions = [
                        { name: '1 portion (100g)', value: 100, unit: 'g' },
                        { name: '1 petite portion (80g)', value: 80, unit: 'g' },
                        { name: '1 grosse portion (150g)', value: 150, unit: 'g' },
                        { name: '200g', value: 200, unit: 'g' }
                    ];
                }
                // Snacks et confiseries
                else if (categories.includes('snack') || categories.includes('confiserie') || categories.includes('chocolate') ||
                         productName.includes('chocolat') || productName.includes('chips') || productName.includes('cookie')) {
                    portions = [
                        { name: '1 portion (30g)', value: 30, unit: 'g' },
                        { name: '1 petit paquet (25g)', value: 25, unit: 'g' },
                        { name: '1 carré (10g)', value: 10, unit: 'g' },
                        { name: '50g', value: 50, unit: 'g' }
                    ];
                }
                
                // Ajouter portion personnalisée du produit si disponible
                if (product.serving_size) {
                    const servingSize = parseFloat(product.serving_size);
                    if (servingSize > 0 && servingSize <= 1000) {
                        portions.unshift({ 
                            name: `${servingSize}g (portion recommandée)`, 
                            value: servingSize, 
                            unit: 'g' 
                        });
                    }
                }
                
                container.innerHTML = portions.map((portion, index) => `
                    <div class="portion-btn" data-index="${index}" data-value="${portion.value}" data-unit="${portion.unit}">
                        ${portion.name}
                    </div>
                `).join('');

                // Ajouter les événements
                container.querySelectorAll('.portion-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const index = parseInt(this.getAttribute('data-index'));
                        const value = parseFloat(this.getAttribute('data-value'));
                        const unit = this.getAttribute('data-unit');
                        selectPortion(index, value, unit);
                    });
                });
            } catch (error) {
                console.error('Erreur génération portions:', error);
            }
        }

        function selectPortion(index, value, unit) {
            try {
                document.querySelectorAll('.portion-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                
                const buttons = document.querySelectorAll('.portion-btn');
                if (buttons[index]) {
                    buttons[index].classList.add('selected');
                }
                
                selectedPortion = { value, unit };
                updateElement('customQuantity', value);
                
                const customUnit = document.getElementById('customUnit');
                if (customUnit) {
                    customUnit.value = unit;
                }
            } catch (error) {
                console.error('Erreur sélection portion:', error);
            }
        }

        function addToJournal() {
            try {
                if (!selectedFood) return;

                const quantity = parseFloat(document.getElementById('customQuantity').value);
                const unit = document.getElementById('customUnit').value;
                
                if (!quantity || quantity <= 0) {
                    alert('Veuillez entrer une quantité valide');
                    return;
                }

                const today = new Date().toISOString().split('T')[0];
                const nutrients = selectedFood.nutriments || {};
                
                let multiplier = quantity / 100;
                if (unit === 'portion' && selectedFood.serving_size) {
                    multiplier = (quantity * parseFloat(selectedFood.serving_size)) / 100;
                } else if (unit === 'ml') {
                    multiplier = quantity / 100;
                }

                const entry = {
                    id: Date.now(),
                    name: selectedFood.product_name,
                    brand: selectedFood.brands || '',
                    quantity: quantity,
                    unit: unit,
                    calories: Math.round((nutrients['energy-kcal_100g'] || 0) * multiplier),
                    protein: Math.round((nutrients.proteins_100g || 0) * multiplier * 10) / 10,
                    carbs: Math.round((nutrients.carbohydrates_100g || 0) * multiplier * 10) / 10,
                    fat: Math.round((nutrients.fat_100g || 0) * multiplier * 10) / 10,
                    time: new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})
                };

                if (!userData.foodJournal[today]) {
                    userData.foodJournal[today] = [];
                }
                userData.foodJournal[today].push(entry);

                saveUserData();
                updateDashboard();
                cancelAddFood();
                showSuccessMessage('Aliment ajouté au journal !');
            } catch (error) {
                console.error('Erreur ajout journal:', error);
                alert('Erreur lors de l\'ajout de l\'aliment');
            }
        }

        function cancelAddFood() {
            try {
                selectedFood = null;
                selectedPortion = null;
                
                const addFoodForm = document.getElementById('addFoodForm');
                const foodSearchInput = document.getElementById('foodSearchInput');
                const searchResults = document.getElementById('searchResults');
                
                if (addFoodForm) addFoodForm.classList.add('hidden');
                if (foodSearchInput) foodSearchInput.value = '';
                if (searchResults) searchResults.classList.add('hidden');
            } catch (error) {
                console.error('Erreur annulation:', error);
            }
        }

        function removeMeal(date, mealId) {
            try {
                if (userData.foodJournal[date]) {
                    userData.foodJournal[date] = userData.foodJournal[date].filter(meal => meal.id !== mealId);
                    saveUserData();
                    updateDashboard();
                }
            } catch (error) {
                console.error('Erreur suppression repas:', error);
            }
        }

        function updateDashboard() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const todayMeals = userData.foodJournal[today] || [];
                
                const totals = todayMeals.reduce((acc, meal) => {
                    acc.calories += meal.calories || 0;
                    acc.protein += meal.protein || 0;
                    acc.carbs += meal.carbs || 0;
                    acc.fat += meal.fat || 0;
                    return acc;
                }, { calories: 0, protein: 0, carbs: 0, fat: 0 });

                updateElement('caloriesConsumed', Math.round(totals.calories));
                updateElement('proteinConsumed', Math.round(totals.protein * 10) / 10 + 'g');
                updateElement('carbsConsumed', Math.round(totals.carbs * 10) / 10 + 'g');
                updateElement('fatConsumed', Math.round(totals.fat * 10) / 10 + 'g');

                if (userData.dailyNeeds && userData.dailyNeeds.calories) {
                    updateElement('caloriesTarget', userData.dailyNeeds.calories);
                    updateElement('proteinTarget', userData.dailyNeeds.protein + 'g');
                    updateElement('carbsTarget', userData.dailyNeeds.carbs + 'g');
                    updateElement('fatTarget', userData.dailyNeeds.fat + 'g');

                    updateProgressBars(totals);
                }

                displayTodayMeals(todayMeals);
                updateWeeklyChart();
            } catch (error) {
                console.error('Erreur mise à jour dashboard:', error);
            }
        }

        function updateProgressBars(totals) {
            try {
                if (!userData.dailyNeeds || !userData.dailyNeeds.protein) return;

                const proteinPercent = Math.min((totals.protein / userData.dailyNeeds.protein) * 100, 100);
                const carbsPercent = Math.min((totals.carbs / userData.dailyNeeds.carbs) * 100, 100);
                const fatPercent = Math.min((totals.fat / userData.dailyNeeds.fat) * 100, 100);

                const proteinBar = document.getElementById('proteinBar');
                const carbsBar = document.getElementById('carbsBar');
                const fatBar = document.getElementById('fatBar');

                if (proteinBar) proteinBar.style.width = proteinPercent + '%';
                if (carbsBar) carbsBar.style.width = carbsPercent + '%';
                if (fatBar) fatBar.style.width = fatPercent + '%';

                updateElement('proteinPercent', Math.round(proteinPercent));
                updateElement('carbsPercent', Math.round(carbsPercent));
                updateElement('fatPercent', Math.round(fatPercent));
            } catch (error) {
                console.error('Erreur barres progression:', error);
            }
        }

        function displayTodayMeals(meals) {
            try {
                const container = document.getElementById('todayMeals');
                if (!container) return;
                
                if (meals.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #718096; padding: 20px;">Aucun repas ajouté aujourd\'hui</p>';
                    return;
                }

                container.innerHTML = meals.map(meal => `
                    <div class="meal-entry">
                        <div>
                            <strong>${meal.name}</strong>
                            <br>
                            <small>${meal.brand ? meal.brand + ' • ' : ''}${meal.quantity}${meal.unit} • ${meal.time}</small>
                            <br>
                            <small>${meal.calories} kcal • ${meal.protein}g P • ${meal.carbs}g G • ${meal.fat}g L</small>
                        </div>
                        <button class="btn btn-danger" onclick="removeMeal('${new Date().toISOString().split('T')[0]}', ${meal.id})" style="padding: 5px 10px; font-size: 12px;">×</button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Erreur affichage repas:', error);
            }
        }

        function initializeCharts() {
            try {
                const weeklyCtx = document.getElementById('weeklyChart');
                if (weeklyCtx) {
                    charts.weekly = new Chart(weeklyCtx, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Calories',
                                data: [],
                                borderColor: '#667eea',
                                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Erreur initialisation graphiques:', error);
            }
        }

        function updateWeeklyChart() {
            try {
                if (!charts.weekly) return;
                
                const last7Days = [];
                const calories = [];
                
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    
                    last7Days.push(date.toLocaleDateString('fr-FR', { month: 'short', day: 'numeric' }));
                    
                    const dayMeals = userData.foodJournal[dateStr] || [];
                    const dayCalories = dayMeals.reduce((sum, meal) => sum + (meal.calories || 0), 0);
                    calories.push(dayCalories);
                }
                
                charts.weekly.data.labels = last7Days;
                charts.weekly.data.datasets[0].data = calories;
                charts.weekly.update();
            } catch (error) {
                console.error('Erreur mise à jour graphique:', error);
            }
        }

        function updateAnalyticsCharts() {
            try {
                updateAnalyticsStats();
                updateCaloriesChart();
            } catch (error) {
                console.error('Erreur graphiques analytiques:', error);
            }
        }

        function updateCaloriesChart() {
            try {
                const ctx = document.getElementById('caloriesChart');
                if (!ctx) return;
                
                if (charts.calories) charts.calories.destroy();
                
                const last30Days = [];
                const caloriesData = [];
                
                for (let i = 29; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    
                    last30Days.push(date.getDate());
                    
                    const dayMeals = userData.foodJournal[dateStr] || [];
                    const dayCalories = dayMeals.reduce((sum, meal) => sum + (meal.calories || 0), 0);
                    caloriesData.push(dayCalories);
                }
                
                charts.calories = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: last30Days,
                        datasets: [{
                            label: 'Calories quotidiennes',
                            data: caloriesData,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            } catch (error) {
                console.error('Erreur graphique calories:', error);
            }
        }

        function updateAnalyticsStats() {
            try {
                let totalCalories = 0;
                let validDays = 0;
                let streak = 0;
                let currentStreak = 0;
                const uniqueFoods = new Set();
                
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    
                    const dayMeals = userData.foodJournal[dateStr] || [];
                    if (dayMeals.length > 0) {
                        totalCalories += dayMeals.reduce((sum, meal) => sum + (meal.calories || 0), 0);
                        validDays++;
                        currentStreak++;
                        
                        dayMeals.forEach(meal => uniqueFoods.add(meal.name));
                    } else if (i < 6) {
                        if (currentStreak > streak) streak = currentStreak;
                        currentStreak = 0;
                    }
                }
                
                if (currentStreak > streak) streak = currentStreak;
                
                updateElement('avgCalories', validDays > 0 ? Math.round(totalCalories / validDays) : 0);
                updateElement('streak', streak);
                updateElement('totalFoods', uniqueFoods.size);
                
                // Trouver le meilleur jour
                let bestDay = '-';
                let bestScore = 0;
                
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    
                    const dayMeals = userData.foodJournal[dateStr] || [];
                    if (dayMeals.length > 0) {
                        const totals = dayMeals.reduce((acc, meal) => {
                            acc.calories += meal.calories || 0;
                            return acc;
                        }, { calories: 0 });
                        
                        const needs = userData.dailyNeeds;
                        if (needs && needs.calories) {
                            const score = 100 - Math.abs(totals.calories - needs.calories) / needs.calories * 100;
                            if (score > bestScore) {
                                bestScore = score;
                                bestDay = date.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric' });
                            }
                        }
                    }
                }
                
                updateElement('bestDay', bestDay);
            } catch (error) {
                console.error('Erreur stats analytiques:', error);
            }
        }

        // Fonctions scanner
        function toggleScanner() {
            if (scannerActive) {
                stopScanner();
            } else {
                startScanner();
            }
        }

        function startScanner() {
            try {
                const container = document.getElementById('scannerContainer');
                const video = document.getElementById('scannerVideo');
                
                if (!container || !video) {
                    alert('Scanner non disponible');
                    return;
                }
                
                container.style.display = 'block';
                scannerActive = true;
                
                navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                }).then(stream => {
                    video.srcObject = stream;
                    video.play();
                    showSuccessMessage('Scanner activé - Pointez vers un code-barres');
                }).catch(err => {
                    console.error('Erreur caméra:', err);
                    alert('Impossible d\'accéder à la caméra');
                    stopScanner();
                });
            } catch (error) {
                console.error('Erreur scanner:', error);
                alert('Erreur lors du démarrage du scanner');
            }
        }

        function stopScanner() {
            try {
                const container = document.getElementById('scannerContainer');
                const video = document.getElementById('scannerVideo');
                
                if (video && video.srcObject) {
                    video.srcObject.getTracks().forEach(track => track.stop());
                }
                
                if (container) {
                    container.style.display = 'none';
                }
                
                scannerActive = false;
            } catch (error) {
                console.error('Erreur arrêt scanner:', error);
            }
        }

        // IA Nutritionnelle
        async function sendAiMessage() {
            try {
                const input = document.getElementById('aiInput');
                const message = input.value.trim();
                
                if (!message) return;
                
                input.value = '';
                addChatMessage(message, 'user');
                
                const response = await getAiResponse(message);
                addChatMessage(response, 'ai');
            } catch (error) {
                addChatMessage('Désolé, je ne peux pas répondre pour le moment. Veuillez réessayer plus tard.', 'ai');
            }
        }

        function askAi(question) {
            const aiInput = document.getElementById('aiInput');
            if (aiInput) {
                aiInput.value = question;
                sendAiMessage();
            }
        }

        function addChatMessage(message, sender) {
            try {
                const chat = document.getElementById('aiChat');
                if (!chat) return;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${sender}`;
                
                if (sender === 'ai') {
                    messageDiv.innerHTML = `<strong>🤖 Assistant IA</strong><br>${message}`;
                } else {
                    messageDiv.innerHTML = `<strong>👤 Vous</strong><br>${message}`;
                }
                
                chat.appendChild(messageDiv);
                chat.scrollTop = chat.scrollHeight;
            } catch (error) {
                console.error('Erreur message chat:', error);
            }
        }

        async function getAiResponse(message) {
            try {
                const context = generateNutritionalContext();
                
                if (message.toLowerCase().includes('progression') || message.toLowerCase().includes('semaine')) {
                    return analyzeWeeklyProgress();
                } else if (message.toLowerCase().includes('recette') || message.toLowerCase().includes('protéine')) {
                    return suggestProteinRecipes();
                } else if (message.toLowerCase().includes('équilibre') || message.toLowerCase().includes('conseil')) {
                    return giveNutritionalAdvice();
                } else if (message.toLowerCase().includes('demain') || message.toLowerCase().includes('besoin')) {
                    return calculateTomorrowNeeds();
                } else {
                    return getGeneralNutritionalResponse(message);
                }
            } catch (error) {
                console.error('Erreur réponse IA:', error);
                return 'Désolé, une erreur s\'est produite lors du traitement de votre demande.';
            }
        }

        function generateNutritionalContext() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const todayMeals = userData.foodJournal[today] || [];
                
                const totals = todayMeals.reduce((acc, meal) => {
                    acc.calories += meal.calories || 0;
                    acc.protein += meal.protein || 0;
                    acc.carbs += meal.carbs || 0;
                    acc.fat += meal.fat || 0;
                    return acc;
                }, { calories: 0, protein: 0, carbs: 0, fat: 0 });
                
                return {
                    profile: userData.profile,
                    needs: userData.dailyNeeds,
                    today: totals,
                    meals: todayMeals
                };
            } catch (error) {
                console.error('Erreur contexte nutritionnel:', error);
                return {};
            }
        }

        function analyzeWeeklyProgress() {
            try {
                const context = generateNutritionalContext();
                let analysis = "📊 **Analyse de votre semaine nutritionnelle :**\n\n";
                
                let weeklyCalories = 0;
                let daysWithData = 0;
                
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    
                    const dayMeals = userData.foodJournal[dateStr] || [];
                    if (dayMeals.length > 0) {
                        weeklyCalories += dayMeals.reduce((sum, meal) => sum + (meal.calories || 0), 0);
                        daysWithData++;
                    }
                }
                
                if (daysWithData > 0) {
                    const avgDaily = Math.round(weeklyCalories / daysWithData);
                    const target = context.needs.calories || 2000;
                    
                    analysis += `• **Moyenne quotidienne :** ${avgDaily} kcal\n`;
                    analysis += `• **Objectif :** ${target} kcal\n`;
                    
                    if (avgDaily < target * 0.9) {
                        analysis += `• ⚠️ **Déficit calorique important** : Vous êtes ${target - avgDaily} kcal en dessous de votre objectif\n`;
                        analysis += `• 💡 **Conseil :** Ajoutez des collations nutritives (fruits à coque, yaourt grec)\n`;
                    } else if (avgDaily > target * 1.1) {
                        analysis += `• ⚠️ **Surplus calorique** : Vous dépassez de ${avgDaily - target} kcal votre objectif\n`;
                        analysis += `• 💡 **Conseil :** Privilégiez les légumes et réduisez les portions\n`;
                    } else {
                        analysis += `• ✅ **Excellent équilibre** : Vous respectez parfaitement vos objectifs !\n`;
                    }
                    
                    analysis += `\n📈 **Régularité :** ${daysWithData}/7 jours suivis`;
                } else {
                    analysis += "Aucune donnée disponible pour cette semaine. Commencez dès aujourd'hui !";
                }
                
                return analysis;
            } catch (error) {
                console.error('Erreur analyse semaine:', error);
                return 'Erreur lors de l\'analyse de votre progression.';
            }
        }

        function suggestProteinRecipes() {
            try {
                const context = generateNutritionalContext();
                const proteinNeeded = Math.max(0, (context.needs.protein || 150) - context.today.protein);
                
                let suggestions = "🥩 **Recettes riches en protéines adaptées à vos besoins :**\n\n";
                
                if (proteinNeeded > 30) {
                    suggestions += "**Il vous manque encore " + Math.round(proteinNeeded) + "g de protéines aujourd'hui !**\n\n";
                    
                    suggestions += "🍗 **Plat principal (25-30g protéines) :**\n";
                    suggestions += "• Blanc de poulet grillé (150g) + quinoa + légumes verts\n";
                    suggestions += "• Saumon teriyaki (120g) + riz complet + brocolis\n";
                    suggestions += "• Omelette aux 3 œufs + fromage + épinards\n\n";
                    
                    suggestions += "🥤 **Collation protéinée (15-20g) :**\n";
                    suggestions += "• Yaourt grec (200g) + fruits rouges + granola\n";
                    suggestions += "• Smoothie protéiné : lait + banane + beurre de cacahuète\n";
                    suggestions += "• Cottage cheese + noix + miel\n";
                } else if (proteinNeeded > 10) {
                    suggestions += "**Encore " + Math.round(proteinNeeded) + "g de protéines à ajouter :**\n\n";
                    suggestions += "• 30g d'amandes ou noix\n";
                    suggestions += "• 1 œuf dur + 1 tranche de jambon\n";
                    suggestions += "• 150g de yaourt grec nature\n";
                } else {
                    suggestions += "✅ **Félicitations !** Vos besoins en protéines sont presque atteints.\n\n";
                    suggestions += "🌟 **Recettes pour demain :**\n";
                    suggestions += "• Bowl de quinoa aux légumes et feta\n";
                    suggestions += "• Salade de lentilles au saumon fumé\n";
                    suggestions += "• Curry de pois chiches et épinards\n";
                }
                
                return suggestions;
            } catch (error) {
                console.error('Erreur suggestions recettes:', error);
                return 'Erreur lors de la génération des suggestions de recettes.';
            }
        }

        function giveNutritionalAdvice() {
            try {
                const context = generateNutritionalContext();
                let advice = "⚖️ **Conseils pour optimiser votre équilibre nutritionnel :**\n\n";
                
                const proteinRatio = context.today.protein / (context.needs.protein || 150);
                const carbsRatio = context.today.carbs / (context.needs.carbs || 250);
                const fatRatio = context.today.fat / (context.needs.fat || 67);
                
                if (proteinRatio < 0.8) {
                    advice += "🥩 **Protéines insuffisantes** : Ajoutez une source de protéines à chaque repas\n";
                    advice += "   → Œufs au petit-déjeuner, légumineuses au déjeuner, poisson le soir\n\n";
                }
                
                if (carbsRatio > 1.2) {
                    advice += "🍞 **Excès de glucides** : Privilégiez les glucides complexes et réduisez les portions\n";
                    advice += "   → Remplacez les pâtes blanches par des légumes ou quinoa\n\n";
                }
                
                if (fatRatio < 0.6) {
                    advice += "🥑 **Lipides insuffisants** : Ajoutez des bonnes graisses\n";
                    advice += "   → Avocat, noix, huile d'olive, graines de lin\n\n";
                }
                
                advice += "💡 **Conseils généraux :**\n";
                advice += "• Buvez 2-3L d'eau par jour\n";
                advice += "• Mangez 5 portions de fruits et légumes\n";
                advice += "• Préparez vos repas à l'avance\n";
                advice += "• Écoutez votre sensation de satiété\n";
                
                return advice;
            } catch (error) {
                console.error('Erreur conseils nutritionnels:', error);
                return 'Erreur lors de la génération des conseils nutritionnels.';
            }
        }

        function calculateTomorrowNeeds() {
            try {
                const context = generateNutritionalContext();
                let tomorrow = "🎯 **Vos besoins nutritionnels pour demain :**\n\n";
                
                if (context.needs.calories) {
                    tomorrow += `📊 **Objectifs quotidiens :**\n`;
                    tomorrow += `• **Calories :** ${context.needs.calories} kcal\n`;
                    tomorrow += `• **Protéines :** ${context.needs.protein}g\n`;
                    tomorrow += `• **Glucides :** ${context.needs.carbs}g\n`;
                    tomorrow += `• **Lipides :** ${context.needs.fat}g\n\n`;
                    
                    tomorrow += "🍽️ **Répartition suggérée :**\n";
                    tomorrow += `• **Petit-déjeuner :** ${Math.round(context.needs.calories * 0.25)} kcal\n`;
                    tomorrow += `• **Déjeuner :** ${Math.round(context.needs.calories * 0.35)} kcal\n`;
                    tomorrow += `• **Dîner :** ${Math.round(context.needs.calories * 0.30)} kcal\n`;
                    tomorrow += `• **Collations :** ${Math.round(context.needs.calories * 0.10)} kcal\n`;
                } else {
                    tomorrow += "⚠️ Veuillez d'abord calculer vos besoins dans l'onglet Profil !";
                }
                
                return tomorrow;
            } catch (error) {
                console.error('Erreur calcul besoins demain:', error);
                return 'Erreur lors du calcul des besoins pour demain.';
            }
        }

        function getGeneralNutritionalResponse(message) {
            const responses = [
                "Je suis là pour vous aider avec vos questions nutritionnelles ! Posez-moi des questions spécifiques sur votre alimentation, vos objectifs ou demandez-moi d'analyser votre progression.",
                "Pour une réponse plus précise, pourriez-vous me dire si vous souhaitez des conseils sur l'équilibre nutritionnel, des suggestions de recettes, ou une analyse de votre progression ?",
                "N'hésitez pas à utiliser les suggestions rapides ci-dessous ou à me poser des questions sur : votre progression, des recettes adaptées à vos macros, ou des conseils personnalisés."
            ];
            
            return responses[Math.floor(Math.random() * responses.length)];
        }

        // Gestion des données
        async function saveUserData() {
            try {
                showSyncStatus('syncing');
                const dataStr = JSON.stringify(userData);
                
                // Sauvegarde localStorage (priorité - toujours disponible)
                localStorage.setItem('nutritionTrackerData', dataStr);
                console.log('Données sauvegardées dans localStorage');
                
                // Tentative IndexedDB (optionnel - ne doit pas bloquer)
                try {
                    if ('indexedDB' in window) {
                        await saveToIndexedDB(userData);
                        console.log('Données sauvegardées dans IndexedDB');
                    }
                } catch (indexedDBError) {
                    console.log('IndexedDB non disponible, utilisation localStorage uniquement:', indexedDBError.message);
                }
                
                userData.sync.lastBackup = new Date().toISOString();
                updateSyncInfo();
                showSyncStatus('synced');
                
                return true;
            } catch (error) {
                console.error('Erreur sauvegarde globale:', error);
                showSyncStatus('error');
                
                // Même en cas d'erreur, essayer localStorage en dernier recours
                try {
                    localStorage.setItem('nutritionTrackerData', JSON.stringify(userData));
                    showSyncStatus('synced');
                    return true;
                } catch (localStorageError) {
                    console.error('Échec complet de la sauvegarde:', localStorageError);
                    return false;
                }
            }
        }

        async function loadUserData() {
            try {
                let loadedData = null;
                
                // Tentative IndexedDB en premier
                try {
                    if ('indexedDB' in window) {
                        loadedData = await loadFromIndexedDB();
                        if (loadedData) {
                            console.log('Données chargées depuis IndexedDB');
                        }
                    }
                } catch (indexedDBError) {
                    console.log('Erreur chargement IndexedDB:', indexedDBError.message);
                }
                
                // Fallback vers localStorage
                if (!loadedData) {
                    try {
                        const savedData = localStorage.getItem('nutritionTrackerData');
                        if (savedData) {
                            loadedData = JSON.parse(savedData);
                            console.log('Données chargées depuis localStorage');
                        }
                    } catch (localStorageError) {
                        console.log('Erreur chargement localStorage:', localStorageError.message);
                    }
                }
                
                if (loadedData) {
                    // Fusionner les données chargées avec la structure par défaut
                    userData = {
                        profile: loadedData.profile || {},
                        dailyNeeds: loadedData.dailyNeeds || {},
                        foodJournal: loadedData.foodJournal || {},
                        settings: {
                            ...userData.settings,
                            ...(loadedData.settings || {})
                        },
                        sync: {
                            ...userData.sync,
                            ...(loadedData.sync || {})
                        }
                    };
                    
                    // Restaurer le profil dans l'interface
                    if (userData.profile) {
                        Object.keys(userData.profile).forEach(key => {
                            const element = document.getElementById(key);
                            if (element && userData.profile[key]) {
                                element.value = userData.profile[key];
                            }
                        });
                    }
                    
                    console.log('Données utilisateur chargées avec succès');
                } else {
                    console.log('Aucune donnée sauvegardée trouvée - nouveau utilisateur');
                }
                
                return true;
            } catch (error) {
                console.error('Erreur chargement globale:', error);
                return false;
            }
        }

        function saveToIndexedDB(data) {
            return new Promise((resolve, reject) => {
                try {
                    const request = indexedDB.open('NutritionTracker', 1);
                    
                    request.onerror = () => {
                        console.log('IndexedDB non disponible, utilisation localStorage uniquement');
                        resolve(); // Ne pas bloquer, continuer avec localStorage
                    };
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        
                        // Supprimer l'ancien store s'il existe
                        if (db.objectStoreNames.contains('userData')) {
                            db.deleteObjectStore('userData');
                        }
                        
                        // Créer le nouveau store
                        db.createObjectStore('userData', { keyPath: 'id' });
                    };
                    
                    request.onsuccess = () => {
                        try {
                            const db = request.result;
                            
                            // Vérifier que le store existe
                            if (!db.objectStoreNames.contains('userData')) {
                                console.log('Store userData non trouvé, utilisation localStorage uniquement');
                                resolve();
                                return;
                            }
                            
                            const transaction = db.transaction(['userData'], 'readwrite');
                            const store = transaction.objectStore('userData');
                            
                            store.put({ id: 'main', data: data });
                            
                            transaction.oncomplete = () => resolve();
                            transaction.onerror = () => {
                                console.log('Erreur transaction IndexedDB, utilisation localStorage uniquement');
                                resolve();
                            };
                        } catch (error) {
                            console.log('Erreur IndexedDB:', error.message);
                            resolve(); // Ne pas bloquer
                        }
                    };
                } catch (error) {
                    console.log('IndexedDB non supporté:', error.message);
                    resolve(); // Continuer sans IndexedDB
                }
            });
        }

        function loadFromIndexedDB() {
            return new Promise((resolve) => {
                try {
                    const request = indexedDB.open('NutritionTracker', 1);
                    
                    request.onerror = () => {
                        console.log('IndexedDB non disponible pour la lecture');
                        resolve(null);
                    };
                    
                    request.onupgradeneeded = () => {
                        // Base de données vide, rien à charger
                        resolve(null);
                    };
                    
                    request.onsuccess = () => {
                        try {
                            const db = request.result;
                            
                            // Vérifier que le store existe
                            if (!db.objectStoreNames.contains('userData')) {
                                console.log('Store userData non trouvé pour la lecture');
                                resolve(null);
                                return;
                            }
                            
                            const transaction = db.transaction(['userData'], 'readonly');
                            const store = transaction.objectStore('userData');
                            const getRequest = store.get('main');
                            
                            getRequest.onsuccess = () => {
                                resolve(getRequest.result ? getRequest.result.data : null);
                            };
                            
                            getRequest.onerror = () => {
                                console.log('Erreur lecture IndexedDB');
                                resolve(null);
                            };
                        } catch (error) {
                            console.log('Erreur accès IndexedDB:', error.message);
                            resolve(null);
                        }
                    };
                } catch (error) {
                    console.log('IndexedDB non supporté pour la lecture:', error.message);
                    resolve(null);
                }
            });
        }

        function exportData() {
            try {
                const dataStr = JSON.stringify(userData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `nutrition-data-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                
                URL.revokeObjectURL(url);
                showSuccessMessage('Données exportées avec succès !');
            } catch (error) {
                console.error('Erreur export:', error);
                alert('Erreur lors de l\'export');
            }
        }

        function importData() {
            const importFile = document.getElementById('importFile');
            if (importFile) {
                importFile.click();
            }
        }

        function handleImportFile(event) {
            try {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        if (confirm('Êtes-vous sûr de vouloir importer ces données ? Cela remplacera vos données actuelles.')) {
                            userData = { ...userData, ...importedData };
                            saveUserData();
                            location.reload();
                        }
                    } catch (error) {
                        alert('Erreur lors de l\'importation : fichier invalide');
                    }
                };
                reader.readAsText(file);
            } catch (error) {
                console.error('Erreur import fichier:', error);
            }
        }

        function syncToCloud() {
            showSyncStatus('syncing');
            setTimeout(() => {
                userData.sync.lastBackup = new Date().toISOString();
                userData.sync.cloudEnabled = true;
                saveUserData();
                updateSyncInfo();
                showSyncStatus('synced');
                showSuccessMessage('Synchronisation cloud réussie !');
            }, 2000);
        }

        function resetData() {
            if (confirm('⚠️ ATTENTION : Cette action supprimera TOUTES vos données de manière définitive. Êtes-vous absolument certain ?')) {
                if (confirm('Dernière confirmation : Voulez-vous vraiment tout supprimer ?')) {
                    try {
                        // Effacer localStorage
                        localStorage.clear();
                        console.log('localStorage effacé');
                        
                        // Effacer IndexedDB de manière sécurisée
                        if ('indexedDB' in window) {
                            try {
                                const deleteRequest = indexedDB.deleteDatabase('NutritionTracker');
                                deleteRequest.onsuccess = () => {
                                    console.log('IndexedDB supprimée avec succès');
                                };
                                deleteRequest.onerror = () => {
                                    console.log('Erreur suppression IndexedDB (non bloquante)');
                                };
                            } catch (error) {
                                console.log('IndexedDB non disponible pour suppression:', error.message);
                            }
                        }
                        
                        // Recharger la page après un court délai
                        setTimeout(() => {
                            location.reload();
                        }, 500);
                        
                    } catch (error) {
                        console.error('Erreur lors de la réinitialisation:', error);
                        alert('Erreur lors de la réinitialisation. Rechargez la page manuellement.');
                        location.reload();
                    }
                }
            }
        }

        function generateWeeklyReport() {
            const report = createWeeklyReportHTML();
            openReportWindow(report, 'Rapport Hebdomadaire');
        }

        function generateMonthlyReport() {
            const report = createMonthlyReportHTML();
            openReportWindow(report, 'Rapport Mensuel');
        }

        function createWeeklyReportHTML() {
            try {
                const weekStart = new Date();
                weekStart.setDate(weekStart.getDate() - 6);
                
                let html = `
                    <h1>📋 Rapport Nutritionnel Hebdomadaire</h1>
                    <p><strong>Période :</strong> ${weekStart.toLocaleDateString('fr-FR')} - ${new Date().toLocaleDateString('fr-FR')}</p>
                    <hr>
                `;
                
                let totalCalories = 0;
                let daysWithData = 0;
                
                html += `<h2>📊 Résumé de la semaine</h2><table border="1" style="width:100%; border-collapse:collapse;">`;
                html += `<tr><th>Date</th><th>Calories</th><th>Protéines</th><th>Glucides</th><th>Lipides</th><th>Repas</th></tr>`;
                
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    
                    const dayMeals = userData.foodJournal[dateStr] || [];
                    const dayTotals = dayMeals.reduce((acc, meal) => {
                        acc.calories += meal.calories || 0;
                        acc.protein += meal.protein || 0;
                        acc.carbs += meal.carbs || 0;
                        acc.fat += meal.fat || 0;
                        return acc;
                    }, { calories: 0, protein: 0, carbs: 0, fat: 0 });
                    
                    if (dayMeals.length > 0) {
                        totalCalories += dayTotals.calories;
                        daysWithData++;
                    }
                    
                    html += `<tr>
                        <td>${date.toLocaleDateString('fr-FR')}</td>
                        <td>${Math.round(dayTotals.calories)}</td>
                        <td>${Math.round(dayTotals.protein)}g</td>
                        <td>${Math.round(dayTotals.carbs)}g</td>
                        <td>${Math.round(dayTotals.fat)}g</td>
                        <td>${dayMeals.length}</td>
                    </tr>`;
                }
                
                html += `</table>`;
                
                if (daysWithData > 0) {
                    html += `<h2>📈 Moyennes quotidiennes</h2>`;
                    html += `<ul>
                        <li><strong>Calories :</strong> ${Math.round(totalCalories / daysWithData)} kcal</li>
                    </ul>`;
                }
                
                return html;
            } catch (error) {
                console.error('Erreur rapport hebdomadaire:', error);
                return '<p>Erreur lors de la génération du rapport</p>';
            }
        }

        function createMonthlyReportHTML() {
            try {
                let html = `
                    <h1>📅 Rapport Nutritionnel Mensuel</h1>
                    <p><strong>Mois :</strong> ${new Date().toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' })}</p>
                    <hr>
                `;
                
                const monthlyData = {};
                const today = new Date();
                const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(today.getFullYear(), today.getMonth(), day);
                    if (date <= today) {
                        const dateStr = date.toISOString().split('T')[0];
                        const dayMeals = userData.foodJournal[dateStr] || [];
                        
                        if (dayMeals.length > 0) {
                            monthlyData[day] = dayMeals.reduce((acc, meal) => {
                                acc.calories += meal.calories || 0;
                                return acc;
                            }, { calories: 0 });
                        }
                    }
                }
                
                const daysWithData = Object.keys(monthlyData).length;
                
                if (daysWithData > 0) {
                    const totals = Object.values(monthlyData).reduce((acc, day) => {
                        acc.calories += day.calories;
                        return acc;
                    }, { calories: 0 });
                    
                    html += `<h2>📊 Statistiques du mois</h2>`;
                    html += `<ul>
                        <li><strong>Jours suivis :</strong> ${daysWithData}/${daysInMonth}</li>
                        <li><strong>Calories moyennes/jour :</strong> ${Math.round(totals.calories / daysWithData)} kcal</li>
                    </ul>`;
                } else {
                    html += `<p>Aucune donnée disponible pour ce mois.</p>`;
                }
                
                return html;
            } catch (error) {
                console.error('Erreur rapport mensuel:', error);
                return '<p>Erreur lors de la génération du rapport</p>';
            }
        }

        function openReportWindow(content, title) {
            try {
                const newWindow = window.open('', '_blank');
                newWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>${title}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            table { border-collapse: collapse; width: 100%; margin: 20px 0; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                            th { background-color: #f2f2f2; }
                            @media print { button { display: none; } }
                        </style>
                    </head>
                    <body>
                        ${content}
                        <button onclick="window.print()">🖨️ Imprimer</button>
                        <button onclick="window.close()">❌ Fermer</button>
                    </body>
                    </html>
                `);
            } catch (error) {
                console.error('Erreur ouverture rapport:', error);
            }
        }

        function exportToCSV() {
            try {
                let csv = 'Date,Aliment,Marque,Quantité,Unité,Calories,Protéines,Glucides,Lipides,Heure\n';
                
                Object.keys(userData.foodJournal).forEach(date => {
                    userData.foodJournal[date].forEach(meal => {
                        csv += `${date},"${meal.name}","${meal.brand || ''}",${meal.quantity},${meal.unit},${meal.calories},${meal.protein},${meal.carbs},${meal.fat},${meal.time}\n`;
                    });
                });
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `nutrition-export-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                
                URL.revokeObjectURL(url);
                showSuccessMessage('Export CSV généré !');
            } catch (error) {
                console.error('Erreur export CSV:', error);
                alert('Erreur lors de l\'export CSV');
            }
        }

        function generatePDF() {
            showSuccessMessage('Fonctionnalité PDF en développement. Utilisez les rapports HTML pour l\'instant.');
        }

        // Fonctions utilitaires
        function updateCurrentDate() {
            try {
                const today = new Date();
                const options = { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                };
                updateElement('currentDate', today.toLocaleDateString('fr-FR', options));
            } catch (error) {
                console.error('Erreur date:', error);
            }
        }

        function showSyncStatus(status) {
            try {
                const statusElement = document.getElementById('syncStatus');
                if (!statusElement) return;
                
                statusElement.className = `sync-status ${status}`;
                
                switch(status) {
                    case 'synced':
                        statusElement.textContent = '✅ Données synchronisées';
                        break;
                    case 'syncing':
                        statusElement.textContent = '🔄 Synchronisation...';
                        break;
                    case 'error':
                        statusElement.textContent = '❌ Erreur de synchronisation';
                        break;
                }
            } catch (error) {
                console.error('Erreur status sync:', error);
            }
        }

        function calculateDataSize() {
            try {
                const dataStr = JSON.stringify(userData);
                const sizeInBytes = new Blob([dataStr]).size;
                const sizeInKB = (sizeInBytes / 1024).toFixed(2);
                
                updateElement('dataSize', `${sizeInKB} KB`);
            } catch (error) {
                console.error('Erreur calcul taille:', error);
            }
        }

        function updateSyncInfo() {
            try {
                const lastSync = userData.sync?.lastBackup;
                
                if (lastSync) {
                    const date = new Date(lastSync);
                    updateElement('lastSync', date.toLocaleString('fr-FR'));
                } else {
                    updateElement('lastSync', 'Jamais');
                }
            } catch (error) {
                console.error('Erreur info sync:', error);
            }
        }

        function autoSave() {
            if (Object.keys(userData.foodJournal).length > 0) {
                saveUserData();
            }
        }

        function showSuccessMessage(message) {
            try {
                const successDiv = document.createElement('div');
                successDiv.className = 'success';
                successDiv.textContent = message;
                
                const container = document.querySelector('.content');
                if (container) {
                    container.insertBefore(successDiv, container.firstChild);
                    
                    setTimeout(() => {
                        successDiv.remove();
                    }, 3000);
                }
            } catch (error) {
                console.error('Erreur message succès:', error);
            }
        }

        function updateElement(id, value) {
            try {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                }
            } catch (error) {
                console.error(`Erreur mise à jour élément ${id}:`, error);
            }
        }

        // Gestionnaires d'événements globaux
        window.addEventListener('beforeunload', function() {
            localStorage.setItem('nutritionTrackerData', JSON.stringify(userData));
        });
    </script>
</body>
</html>